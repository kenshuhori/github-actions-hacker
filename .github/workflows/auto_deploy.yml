name: Auto deploy to staging

on:
  pull_request_target

permissions:
  pull-requests: write
  contents: write

jobs:
  # "Bump version to" で始まるPRを自動で承認・マージ
  auto_merge_bump_pr:
    runs-on: ubuntu-24.04
    if: startsWith(github.event.pull_request.title, 'Bump version to')
    steps:
      - name: Approve and merge PR
        run: |
          gh pr review --approve "$PR_URL"
          gh pr merge --auto --merge "$PR_URL"
        env:
          PR_URL: ${{github.event.pull_request.html_url}}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create_release:
    needs: auto_merge_bump_pr
    runs-on: ubuntu-24.04
    # PRがマージされ、かつタイトルが "Bump version to" で始まる場合のみ実行
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.title, 'Bump version to')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Extract version from PR title
        id: extract_version
        run: |
          # PRタイトルから "Bump version to x.xx.xx" のバージョン部分を抽出
          PR_TITLE="${{ github.event.pull_request.title }}"
          VERSION=$(echo "$PR_TITLE" | sed -n 's/^Bump version to \(.*\)$/\1/p')
          if [ -z "$VERSION" ]; then
            echo "Error: Could not extract version from PR title: $PR_TITLE"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Create and push tag
        run: |
          VERSION="${{ steps.extract_version.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # タグが既に存在するかチェック
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "Tag $VERSION already exists. Skipping tag creation."
          else
            # タグを作成してpush
            git tag "$VERSION"
            git push origin "$VERSION"
            echo "Created and pushed tag: $VERSION"
          fi

      - name: Create GitHub Release with auto-generated notes
        run: |
          VERSION="${{ steps.extract_version.outputs.version }}"
          # Releaseが既に存在するかチェック
          if gh release view "$VERSION" >/dev/null 2>&1; then
            echo "Release $VERSION already exists. Skipping release creation."
          else
            gh release create "$VERSION" \
              --title "$VERSION" \
              --generate-notes \
              --verify-tag
            echo "Created GitHub Release: $VERSION"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
